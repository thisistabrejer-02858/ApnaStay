<% layout('layouts/boilerplate') -%>

<style>
/* Filters */
#filters {
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  padding: 0.5rem 0;
  scrollbar-width: none;
}
#filters::-webkit-scrollbar { display: none; }

.filter {
  flex: 0 0 auto;
  text-align: center;
  opacity: 0.7;
  font-size: 0.9rem;
}
.filter:hover { opacity: 1; cursor: pointer; }

/* Tax */
.tax-info { display: none; }

/* Cards */
.listing-card {
  border-radius: 5px;
  overflow: hidden;
  background: #1c1c1c;
}

.listing-card img {
  height: 220px;
  object-fit: cover;
}

@media (min-width: 768px) {
  .listing-card img {
    height: 260px;
  }
}

.card-body {
  padding: 0.9rem;
}

.card-title {
  font-size: 1rem;
}

.card-text {
  font-size: 0.9rem;
}

/* Wishlist */
.wishlist-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: white;
  border: none;
  padding: 7px;
  border-radius: 50%;
}

.wishlist-btn i {
  color: #ff385c;
  font-size: 16px;
}

/* Prevent horizontal scroll */
body { overflow-x: hidden; }
</style>

<div class="container py-3">
<!-- Filters -->
<div id="filters">

  <div class="filter" data-category="Trending">
    <div><i class="fa-solid fa-fire"></i></div>
    <p>Trending</p>
  </div>

  <div class="filter" data-category="Rooms">
    <div><i class="fa-solid fa-bed"></i></div>
    <p>Rooms</p>
  </div>

  <div class="filter" data-category="Iconic Cities">
    <div><i class="fa-solid fa-mountain-city"></i></div>
    <p>Iconic Cities</p>
  </div>

  <div class="filter" data-category="Amazing Pools">
    <div><i class="fa-solid fa-person-swimming"></i></div>
    <p>Amazing Pools</p>
  </div>

  <div class="filter" data-category="Farms">
    <div><i class="fa-solid fa-cow"></i></div>
    <p>Farms</p>
  </div>

  <div class="filter" data-category="Arctic">
    <div><i class="fa-solid fa-snowflake"></i></div>
    <p>Arctic</p>
  </div>

  <div class="filter" data-category="Camping">
    <div><i class="fa-solid fa-campground"></i></div>
    <p>Camping</p>
  </div>

  <div class="filter" data-category="Domes">
    <div><i class="fa-solid fa-igloo"></i></div>
    <p>Domes</p>
  </div>

  <div class="filter" data-category="Boats">
    <div><i class="fa-solid fa-ship"></i></div>
    <p>Boats</p>
  </div>

  <div class="filter" data-category="Castle">
    <div><i class="fa-brands fa-fort-awesome"></i></div>
    <p>Castle</p>
  </div>

</div>

  <!-- Listings -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-2">
    <% for(let listing of allListings) { %>

    <div class="col">
      <div class="card listing-card position-relative text-light border-0">

        <% 
          let imageUrl = listing.images.url;
          let isWishlisted = wishlist && wishlist.some(
            item => item.toString() === listing._id.toString()
          );
        %>

        <% if(currUser) { %>
        <button type="button"
          class="wishlist-btn"
          data-id="<%= listing._id %>">
          <i class="<%= isWishlisted ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
        </button>
        <% } %>

        <a href="/listings/<%= listing._id %>" class="listing-link">
          <img src="<%= imageUrl %>" class="card-img-top" />
        </a>

        <div class="card-body">
          <h5 class="card-title"><%= listing.title %></h5>
          <p class="card-text">
            â‚¹<%= listing.price.toLocaleString("en-IN") %>/night <br>
            <%= listing.country %>
          </p>
        </div>

      </div>
    </div>

    <% } %>
  </div>

</div>

<script>
document.querySelectorAll(".filter").forEach(filter=>{
  filter.addEventListener("click",()=>{
    const category = filter.getAttribute("data-category");
    window.location.href = `/listings?category=${encodeURIComponent(category)}`;
  });
});

document.querySelectorAll(".wishlist-btn").forEach(button=>{
  button.addEventListener("click", async (e)=>{
    e.preventDefault();
    e.stopPropagation();

    const id = button.dataset.id;
    const icon = button.querySelector("i");
    const active = icon.classList.contains("fa-solid");

    const res = await fetch(`/wishlist/${id}`, {
      method: active ? "DELETE" : "POST"
    });

    const data = await res.json();

    if(data.success){
      icon.classList.toggle("fa-solid");
      icon.classList.toggle("fa-regular");
    }
  });
});
</script>